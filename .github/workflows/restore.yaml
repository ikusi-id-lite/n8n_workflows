name: n8n Import Workflows (Optimized arc-runner-set)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Selecciona el modo de importaci√≥n'
        required: true
        default: 'single'
        type: choice
        options:
          - single
          - all
      file_name:
        description: 'Archivo (ej: mi-flujo-YH8YLjPiXhZj70X2.json)'
        required: false
        default: ''

jobs:
  import-n8n:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Run Import Script
        env:
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          N8N_BASE_URL: 'http://n8n:5678/api/v1'
          IMPORT_MODE: ${{ github.event.inputs.mode }}
          FILE_NAME: ${{ github.event.inputs.file_name }}
        run: |
          python << 'EOF'
          import os
          import json
          import requests
          import glob
          import re

          api_key = os.getenv('N8N_API_KEY')
          base_url = os.getenv('N8N_BASE_URL').rstrip('/')
          mode = os.getenv('IMPORT_MODE')
          target_file = os.getenv('FILE_NAME')

          headers = {
              "X-N8N-API-KEY": api_key,
              "Content-Type": "application/json"
          }

          def extract_id(filename):
              # Cambiado de \d+ a [a-zA-Z0-9]+ para soportar IDs alfanum√©ricos
              # Busca lo que est√© entre el √∫ltimo '-' y el '.json'
              match = re.search(r'-([a-zA-Z0-9]+)\.json$', filename)
              return match.group(1) if match else None

          def upload_workflow(file_path):
              workflow_id = extract_id(file_path)
              if not workflow_id:
                  print(f"‚ö†Ô∏è No se pudo extraer ID de: {file_path}. Saltando...")
                  return

              if not os.path.exists(file_path):
                  print(f"‚ùå El archivo {file_path} no existe en el repo.")
                  return

              with open(file_path, 'r') as f:
                  workflow_data = json.load(f)

              # Limpieza: Para actualizar, n8n no debe recibir el ID dentro del body
              workflow_data.pop('id', None)

              # Intentar ver si existe
              check_res = requests.get(f"{base_url}/workflows/{workflow_id}", headers=headers)

              if check_res.status_code == 200:
                  print(f"üîÑ Actualizando workflow ID: {workflow_id}")
                  res = requests.put(f"{base_url}/workflows/{workflow_id}", headers=headers, json=workflow_data)
              else:
                  print(f"üÜï El ID {workflow_id} no existe en n8n. Creando como nuevo...")
                  res = requests.post(f"{base_url}/workflows", headers=headers, json=workflow_data)
              
              if res.status_code in [200, 201]:
                  print(f"‚úÖ √âxito: {file_path}")
              else:
                  print(f"‚ùå Error en {file_path}: {res.status_code} - {res.text}")

          if mode == 'single':
              if target_file:
                  upload_workflow(target_file)
              else:
                  print("‚ùå Error: Modo 'single' requiere un nombre de archivo.")
          else:
              files = glob.glob("*.json")
              print(f"üìÇ Encontrados {len(files)} archivos JSON.")
              for f in files:
                  upload_workflow(f)
          EOF